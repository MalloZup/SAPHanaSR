#
# Sample(!) setup for SR+QAS/DEV/TST
# (c) 2014 SUSE Linux GmbH, Nuremberg, Germany
# restricted support. Only for PoCs or implementation projects which intensively test their setup
#                     Test-Plan and Results must be present when opening service requests
# GNU Free Documentation License
#
# HANA SLE/00 in SR + HANA QAS/15
#
##############################################################################
#

node suse01 
node suse02 

#
# SLE - SAPHanaSR : SAPHanaTopology primitive+clone
#
primitive rsc_SAPHanaTopology_SLE_HDB00 ocf:suse:SAPHanaTopology \
    operations $id="rsc_sap2_SLE_HDB00-operations" \
    op monitor interval="10" timeout="600" \
    op start interval="0" timeout="600" \
    op stop interval="0" timeout="300" \
    params SID="SLE" InstanceNumber="00"

clone cln_SAPHanaTopology_SLE_HDB00 rsc_SAPHanaTopology_SLE_HDB00 \
    meta clone-node-max="1" 

#
# SLE - SAPHanaSR : SAPHana primitive+master/slave
#
primitive rsc_SAPHana_SLE_HDB00 ocf:suse:SAPHana \
    operations $id="rsc_sap_SLE_HDB00-operations" \
    op start interval="0" timeout="3600" \
    op stop interval="0" timeout="3600" \
    op promote interval="0" timeout="3600" \
    op monitor interval="60" role="Master" timeout="700" \
    op monitor interval="61" role="Slave" timeout="700" \
    params SID="SLE" InstanceNumber="00" AUTOMATED_REGISTER="false" PREFER_SITE_TAKEOVER="true" DUPLICATE_PRIMARY_TIMEOUT="180"

ms msl_SAPHana_SLE_HDB00 rsc_SAPHana_SLE_HDB00 \
    meta notify="true" clone-max="2" clone-node-max="1" priority="1000000"

#
# SLE: IP
#
primitive rsc_ip_SLE_HDB00 ocf:heartbeat:IPaddr2 \
    operations $id="rsc_ip_SLE_HDB00-operations" \
    op monitor interval="10s" timeout="30s" \
    params ip="192.168.1.20"


#
# QAS - SAPDatabase: primitive
#
primitive rsc_SAP_QAS_HDB15 ocf:heartbeat:SAPDatabase \
    params DBTYPE="HDB" SID="QAS" \
    op start interval="0" timeout="600" \
    op monitor interval="120" timeout="700" \
    op stop interval="0" timeout="300" \
    meta priority="100"

primitive rsc_IPMI_suse01 stonith:external/ipmi \
    params hostname="suse01" ipaddr="192.168.1.100" userid="stonith" passwd="k1llm3" interface="lanplus" \
    op monitor interval="1800" timeout="30" 

primitive rsc_IPMI_suse02 stonith:external/ipmi \
    params hostname="suse02" ipaddr="192.168.1.101" userid="stonith" passwd="k1llm3" interface="lanplus" \
    op monitor interval="1800" timeout="30" 

#
# ANTI-Locations
#
location loc_QAS_never_on_suse01        rsc_SAP_QAS_HDB15 -inf: suse01
location loc_suse01IPMI_never_on_suse01 rsc_IPMI_suse01   -inf: suse01
location loc_suse02IPMI_never_on_suse02 rsc_IPMI_suse02   -inf: suse02

#
# Colocations / ANTI-Colocations
#
colocation col_QAS_never_with_ipSLE        -inf: rsc_SAP_QAS_HDB15:Started rsc_ip_SLE_HDB00
colocation col_ipSLE_always_with_SLEMaster 3000: rsc_ip_SLE_HDB00:Started  msl_SAPHana_SLE_HDB00:Master

#
# Oder rules
#
order ord_QAS_stop_before_promote_SLE  inf: rsc_SAP_QAS_HDB15:stop        msl_SAPHana_SLE_HDB00:promote
order ord_SLE_start_Tolpology_first   2000: cln_SAPHanaTopology_SLE_HDB00 msl_SAPHana_SLE_HDB00

#
# Cluster properties and defaults
#
property $id="cib-bootstrap-options" \
    stonith-enabled="true" \
    no-quorum-policy="ignore" \
    stonith-action="poweroff" \
    stonith-timeout="150s" 

rsc_defaults $id="rsc-options" \
    resource-stickiness="1000" \
    migration-threshold="3" \
    resource-threshold="5000"

op_defaults $id="op-options" \
    timeout="600" 
